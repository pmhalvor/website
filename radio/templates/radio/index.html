
<html>
	<head>
		<title>radio</title>
		{% load static %}
		<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
		<link rel="stylesheet" type="text/css" href="{% static 'css/radio.css' %}">
		<link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>
	</head>

	<body>
		{% include "includes/navbar.html" %}

		<div class="container">
			<h1 class="title">RADIO</h1>
			<p>{{ welcome }}</p>
			<p>{{ intro }}</p>

			<div class="main" style="display:inline-block">
				<div class="column">
					<div class="playing" id="playing">
						{% include "includes/playing.html" %}
					</div>
				</div>
				<div class="column">
					<div class="search">
						<h1>got recommendations?</h1>
						<input type="text" name="query" id="query">
						<button type="submit" id="search"> <img src="{% static 'img/search.png'%}" class="icon"></button>
						<div class="results">
							<table>
								<thead>
									<tr>
										<th>artist</th> 
										<th>track</th> 
										<th>album</th> 
										<th>suggest</th>
									</tr>
								</thead>
								<tbody id="results">
									{% include "includes/search.html" %}
								</tbody>
							</table>
						</div>
						<div>
							<h4>my recommendations</h4>
							<table id="recommendations">
							</table>
						</div>
					</div>
				</div>
			</div>

			<br>
			<br>
			<br>

			<h1 style="text-align: right;">recently played</h1>
			<ul class="row" id="recents">
				{% include "includes/recents.html" %}
			</ul>
			
		</div>
		

		
		{% include "includes/footer.html" %}

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<script type="text/javascript" >  
		// UPDATE SCRIPT
			// it'd be nice to get this into it's own file
			var progressbar = document.getElementById("bar");

			var duration = "{{ current.duration }}"*1;  // *1 to make int not string
			var progress = "{{ current.progress }}"*1;
			var percentage;

			function updateProgress(){
				progress = progress + 1000;
				if (duration==0){
					// do nothing
					return;
				}
				else if (progress<duration) {
					percentage = Math.round(100*progress/duration);
					progressbar.style.width = percentage +"%";
					progressbar.innerHTML = percentage +"%";
					return percentage;
				}
				else {
					current();
					recents();
				}
			}

			function current(){
				$.ajax({ // UPDATE NOW PLAYING
					url: "{% url 'current' %}",
					success: function(json) {
						console.log(json.artist, '-', json.track);
						$("#playingArtist").html(json.artist);
						$("#playingTrack").html(json.track);
						$("#artwork").attr("src", json.artwork);
						progress = json.progress*1;
						duration = json.duration*1;
					}
				});
			}
			function recents(){
				$.ajax({ // UPDATE RECENTLY PLAYED 
						url: "{% url 'recents' %}",
						success: function(data) {
							$("#recents").html(data);
						}
					});
			}

			var updating = setInterval(updateProgress, 1000);
		</script>

		<script type="text/javascript">
		// SEARCH SCRIPT
			var query = null;
			// from search bar to backend
			$(document).ready(function(){
				$('#query').keypress(function(e){ // press enter
					if(e.keyCode==13){
						query = $(this).val();
						searchSpotify(query);
					}
				});
				$("#search").click(function() { //press search button
					query = $('#query').val();
					searchSpotify(query);
				});
			});

			function searchSpotify(q){
				if (q!=null){
					alert(q);
					$.ajax({
						url: "{% url 'search' %}",
						data: {"query_str": q},
						success: function(data){
							var empty = $("results").html();
							$("#results").html(data);
						}
					});
				}
			}
		</script>

		<script type="text/javascript">
		// SUGGEST SCRIPT
			// need to get actual returned resutls, use the track ids to submit/remove from receomendations

			// from search to my recommendations
			$("#table tr").click(function(){
				var artist=$(this).find("#artist").html();
				var track=$(this).find("#track").html();
				var id=this.id;
				// id = id.replace(/[.,\/#!?$%\^&\*;:{}=\-_`~() ]/g,""); // remove all special characters
				if ($(this).hasClass('selected')){
					$(this).removeClass('selected');
					$("#"+id).remove();
				}else{
					$(this).addClass('selected');    
					$("#recommendations").append("<tr id=\""+id+"\"><td class='artist'>"+artist+"</td><td class='track'>"+track+"</td><td><input type='button' value='remove'></td></tr>");  
				}
			});

		</script>
	</body>

</html>